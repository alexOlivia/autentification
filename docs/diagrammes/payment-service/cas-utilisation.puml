@startuml Payment Service - Cas d'Utilisation

title Payment Service - Cas d'Utilisation

left to right direction

' Acteurs
actor "Client" as Client
actor "Commerçant" as Merchant
actor "Administrateur" as Admin
actor "Booking Service" as BookingService
actor "Notification Service" as NotificationService
actor "Stripe" as Stripe
actor "Système Bancaire" as Bank

' Package Payment Service
rectangle "Payment Service" {
    ' Cas d'utilisation principaux
    usecase "Traiter paiement" as UC1
    usecase "Gérer remboursements" as UC2
    usecase "Générer factures" as UC3
    usecase "Gérer transactions" as UC4
    usecase "Gérer webhooks Stripe" as UC5
    usecase "Calculer commissions" as UC6
    usecase "Gérer paiements différés" as UC7

    ' Sous-cas pour traiter paiement
    usecase "Créer PaymentIntent Stripe" as UC1_1
    usecase "Confirmer paiement" as UC1_2
    usecase "Annuler paiement" as UC1_3
    usecase "Vérifier statut" as UC1_4
    usecase "Gérer échec paiement" as UC1_5
    usecase "Enregistrer transaction" as UC1_6

    ' Sous-cas pour remboursements
    usecase "Calculer montant remboursement" as UC2_1
    usecase "Appliquer politique annulation" as UC2_2
    usecase "Créer remboursement Stripe" as UC2_3
    usecase "Traiter remboursement" as UC2_4
    usecase "Vérifier statut remboursement" as UC2_5
    usecase "Remboursement partiel" as UC2_6
    usecase "Remboursement total" as UC2_7

    ' Sous-cas pour factures
    usecase "Générer numéro facture" as UC3_1
    usecase "Calculer TVA" as UC3_2
    usecase "Créer PDF facture" as UC3_3
    usecase "Stocker PDF" as UC3_4
    usecase "Envoyer facture par email" as UC3_5
    usecase "Télécharger facture" as UC3_6

    ' Sous-cas pour transactions
    usecase "Enregistrer paiement" as UC4_1
    usecase "Enregistrer remboursement" as UC4_2
    usecase "Enregistrer frais" as UC4_3
    usecase "Enregistrer commission" as UC4_4
    usecase "Générer rapport transactions" as UC4_5

    ' Sous-cas pour webhooks
    usecase "Valider signature webhook" as UC5_1
    usecase "Traiter payment_intent.succeeded" as UC5_2
    usecase "Traiter payment_intent.failed" as UC5_3
    usecase "Traiter charge.refunded" as UC5_4
    usecase "Assurer idempotence" as UC5_5

    ' Sous-cas pour commissions
    usecase "Calculer commission plateforme" as UC6_1
    usecase "Calculer part commerçant" as UC6_2
    usecase "Générer relevé commissions" as UC6_3
    usecase "Transférer fonds commerçant" as UC6_4

    ' Sous-cas pour paiements différés
    usecase "Autoriser prélèvement" as UC7_1
    usecase "Capturer fonds" as UC7_2
    usecase "Annuler autorisation" as UC7_3
}

' Relations acteurs -> cas d'utilisation
Client --> UC1 : paie réservation
Client --> UC2 : demande remboursement
Client --> UC3 : télécharge facture

Merchant --> UC6 : consulte revenus
Merchant --> UC3 : génère factures clients

Admin --> UC4 : consulte toutes transactions
Admin --> UC6 : gère commissions

BookingService --> UC1 : initie paiement
BookingService --> UC2 : demande remboursement (annulation)

NotificationService --> UC3 : envoie facture par email
Stripe --> UC5 : envoie webhooks
Bank --> UC2 : exécute remboursement

' Inclusions et extensions
UC1 ..> UC1_1 : <<include>>
UC1 ..> UC1_2 : <<extend>>\n[si confirmé]
UC1 ..> UC1_3 : <<extend>>\n[si annulation]
UC1 ..> UC1_4 : <<include>>
UC1 ..> UC1_5 : <<extend>>\n[si échec]
UC1 ..> UC1_6 : <<include>>

UC2 ..> UC2_1 : <<include>>
UC2 ..> UC2_2 : <<include>>
UC2 ..> UC2_3 : <<include>>
UC2 ..> UC2_4 : <<include>>
UC2 ..> UC2_5 : <<extend>>
UC2 ..> UC2_6 : <<extend>>
UC2 ..> UC2_7 : <<extend>>

UC3 ..> UC3_1 : <<include>>
UC3 ..> UC3_2 : <<include>>
UC3 ..> UC3_3 : <<include>>
UC3 ..> UC3_4 : <<include>>
UC3 ..> UC3_5 : <<extend>>
UC3 ..> UC3_6 : <<extend>>

UC4 ..> UC4_1 : <<extend>>
UC4 ..> UC4_2 : <<extend>>
UC4 ..> UC4_3 : <<extend>>
UC4 ..> UC4_4 : <<extend>>
UC4 ..> UC4_5 : <<extend>>

UC5 ..> UC5_1 : <<include>>
UC5 ..> UC5_2 : <<extend>>
UC5 ..> UC5_3 : <<extend>>
UC5 ..> UC5_4 : <<extend>>
UC5 ..> UC5_5 : <<include>>

UC6 ..> UC6_1 : <<include>>
UC6 ..> UC6_2 : <<include>>
UC6 ..> UC6_3 : <<extend>>
UC6 ..> UC6_4 : <<extend>>

UC7 ..> UC7_1 : <<include>>
UC7 ..> UC7_2 : <<extend>>\n[si confirmé]
UC7 ..> UC7_3 : <<extend>>\n[si annulé]

' Notes explicatives
note right of UC1
  Processus paiement complet:

  1. Création PaymentIntent Stripe
     - Montant: 50000 XOF
     - Metadata: reservationId, userId
     - Retour: client_secret

  2. Frontend (Stripe Elements):
     - Client entre infos carte
     - Validation côté Stripe
     - 3D Secure si nécessaire

  3. Webhook confirmation:
     - payment_intent.succeeded
     - Mise à jour statut: REUSSI
     - Confirmation réservation
     - Génération facture

  Timeout:
  - Paiement non confirmé après 15min
  - Réservation annulée automatiquement
  - PaymentIntent annulé Stripe

  Sécurité:
  - PCI-DSS compliant (via Stripe)
  - Aucune carte stockée côté serveur
  - Tokens temporaires uniquement
end note

note right of UC2
  Politique de remboursement:

  Calcul automatique selon délai:

  >24h avant début:
  - Remboursement: 100%
  - Délai: 3-5 jours
  - Frais Stripe: non remboursés

  12-24h avant début:
  - Remboursement: 50%
  - Pénalité: 50%
  - Délai: 3-5 jours

  <12h avant début:
  - Remboursement: 0%
  - Montant gardé par commerçant
  - Sauf force majeure (admin approval)

  Commerçant annule:
  - Remboursement: 100%
  - Compensation: +20% (10000 XOF)
  - Immédiat

  No-show client:
  - Remboursement: 0%
  - Pénalité: blacklist 3× no-show

  Exceptions:
  - Maladie (certificat médical): 100%
  - Décès: 100%
  - Catastrophe naturelle: 100%
  - Problème commerçant: 100% + compensation
end note

note bottom of UC3
  Facture conforme réglementations:

  Informations obligatoires:
  - Numéro unique (FACT-2026-XXXXX)
  - Date émission
  - Infos commerçant (SIRET, adresse)
  - Infos client (nom, adresse)
  - Détail prestation
  - Montant HT (Hors Taxe)
  - TVA (18% standard Afrique Ouest)
  - Montant TTC (Toutes Taxes Comprises)
  - Moyens paiement
  - Conditions générales

  Format:
  - PDF généré (PDFKit)
  - Stockage: S3 ou local
  - Téléchargement sécurisé (URL signée)
  - Envoi email automatique

  Numérotation:
  - Séquentielle par année
  - FACT-2026-00001, 00002, ...
  - Pas de trou dans séquence
  - Audit trail complet

  Conservation:
  - Légal: 10 ans minimum
  - Archivage automatique
end note

note right of UC4
  Gestion transactions:

  Types de transactions:

  PAIEMENT (+):
  - Client → Plateforme
  - Montant: +50000 XOF
  - Statut: TRAITE

  FRAIS (-):
  - Plateforme → Stripe
  - Montant: -1550 XOF (2.9% + 100)
  - Statut: TRAITE

  COMMISSION (-):
  - Plateforme → Commission
  - Montant: -5000 XOF (10% plateforme)
  - Statut: TRAITE

  TRANSFERT (-):
  - Plateforme → Commerçant
  - Montant: -43450 XOF (reste)
  - Statut: TRAITE

  REMBOURSEMENT (-):
  - Plateforme → Client
  - Montant: -50000 XOF
  - Statut: TRAITE

  Audit:
  - Toutes transactions loggées
  - Immuables (append-only)
  - Réconciliation quotidienne
  - Détection anomalies
end note

note left of UC5
  Webhooks Stripe sécurisés:

  Validation signature:
  1. Récupérer header Stripe-Signature
  2. Calculer HMAC-SHA256
     (payload + timestamp + secret)
  3. Comparer signatures
  4. Vérifier timestamp (< 5min)
  5. Si valide → Traiter
  6. Si invalide → Rejeter (401)

  Événements traités:
  - payment_intent.succeeded
  - payment_intent.payment_failed
  - payment_intent.canceled
  - charge.refunded
  - charge.failed

  Idempotence:
  - Même event peut arriver 2×
  - Vérifier si déjà traité
  - Utiliser Stripe event ID
  - Éviter double traitement

  Retry Stripe:
  - 3 tentatives sur 3 jours
  - Exponentiel backoff
  - Alerte si échec final
end note

note right of UC6
  Modèle commissions:

  Commission plateforme: 10%
  Exemple paiement 50000 XOF:

  - Client paie: 50000 XOF
  - Frais Stripe: -1550 XOF (3.1%)
  - Commission plateforme: -5000 XOF (10%)
  - Commerçant reçoit: 43450 XOF (86.9%)

  Versements commerçants:
  - Fréquence: Hebdomadaire
  - Jour: Vendredi
  - Délai: D+7
  - Méthode: Virement bancaire
  - Seuil minimum: 10000 XOF

  Relevés:
  - Mensuel par commerçant
  - Détail transactions
  - Total commissions
  - Total versements
  - Export CSV/PDF
end note

note right of UC7
  Paiement différé (optionnel):

  Use case:
  - Réserver maintenant
  - Payer plus tard (check-in)
  - Autorisation carte

  Process:
  1. Autorisation montant (hold)
  2. Fonds bloqués carte client
  3. Capture à check-in ou J-1
  4. Si annulation: release hold

  Avantages:
  - Flexibilité client
  - Garantie commerçant
  - Pas de débit immédiat

  Inconvénients:
  - Complexité technique
  - Expiration autorisation (7j)
  - Risque fonds insuffisants

  Stripe API:
  - capture_method: "manual"
  - payment_intent.capture() later
end note

' Contraintes
note "Paiement requis pour\nconfirmer réservation" as N1
UC1 .. N1

note "Remboursement selon\npolitique commerçant" as N2
UC2 .. N2

note "Facture générée automatiquement\naprès paiement réussi" as N3
UC3 .. N3

note "Webhooks doivent être\nidempotents (retry Stripe)" as N4
UC5 .. N4

note "Commission prélevée\nautomatiquement sur chaque paiement" as N5
UC6 .. N5

@enduml
