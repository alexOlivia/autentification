@startuml Auth Service - Cas d'Utilisation

title Auth Service - Cas d'Utilisation

left to right direction

' Acteurs
actor "Client" as Client
actor "Commerçant" as Merchant
actor "Administrateur" as Admin
actor "Système Gateway" as Gateway
actor "Tâche Planifiée" as Cron

' Package Auth Service
rectangle "Auth Service" {
    ' Cas d'utilisation principaux
    usecase "S'inscrire" as UC1
    usecase "Se connecter" as UC2
    usecase "Se déconnecter" as UC3
    usecase "Rafraîchir token" as UC4
    usecase "Valider token" as UC5
    usecase "Gérer profil" as UC6
    usecase "Changer mot de passe" as UC7
    usecase "Supprimer compte" as UC8
    usecase "Réinitialiser mot de passe" as UC9
    usecase "Gérer rôles et permissions" as UC10
    usecase "Nettoyer tokens expirés" as UC11

    ' Sous-cas d'utilisation pour l'inscription
    usecase "Valider email" as UC1_1
    usecase "Valider mot de passe" as UC1_2
    usecase "Hacher mot de passe" as UC1_3
    usecase "Créer utilisateur en DB" as UC1_4
    usecase "Générer tokens JWT" as UC1_5

    ' Sous-cas pour la connexion
    usecase "Vérifier identifiants" as UC2_1
    usecase "Comparer hash mot de passe" as UC2_2
    usecase "Créer session" as UC2_3
    usecase "Enregistrer token refresh" as UC2_4

    ' Sous-cas pour validation token
    usecase "Vérifier signature JWT" as UC5_1
    usecase "Vérifier expiration" as UC5_2
    usecase "Extraire payload" as UC5_3
    usecase "Vérifier permissions RBAC" as UC5_4

    ' Sous-cas pour gestion profil
    usecase "Consulter profil" as UC6_1
    usecase "Modifier profil" as UC6_2
    usecase "Upload avatar" as UC6_3

    ' Sous-cas pour mot de passe
    usecase "Vérifier ancien mot de passe" as UC7_1
    usecase "Valider nouveau mot de passe" as UC7_2
    usecase "Mettre à jour hash" as UC7_3
    usecase "Révoquer tous tokens" as UC7_4

    ' Sous-cas pour gestion rôles
    usecase "Attribuer rôle" as UC10_1
    usecase "Révoquer rôle" as UC10_2
    usecase "Lister permissions" as UC10_3
}

' Relations acteurs -> cas d'utilisation
Client --> UC1 : s'inscrit comme CLIENT
Merchant --> UC1 : s'inscrit comme MERCHANT
Admin --> UC1 : crée compte ADMIN

Client --> UC2
Merchant --> UC2
Admin --> UC2

Client --> UC3
Merchant --> UC3
Admin --> UC3

Client --> UC4 : renouvelle accès
Merchant --> UC4
Admin --> UC4

Gateway --> UC5 : pour chaque requête

Client --> UC6
Merchant --> UC6
Admin --> UC6

Client --> UC7
Merchant --> UC7
Admin --> UC7

Client --> UC8 : peut supprimer son compte
Merchant --> UC8

Client --> UC9 : si oubli
Merchant --> UC9

Admin --> UC10 : gère les rôles
Cron --> UC11 : quotidiennement

' Inclusions et extensions
UC1 ..> UC1_1 : <<include>>
UC1 ..> UC1_2 : <<include>>
UC1 ..> UC1_3 : <<include>>
UC1 ..> UC1_4 : <<include>>
UC1 ..> UC1_5 : <<include>>

UC2 ..> UC2_1 : <<include>>
UC2 ..> UC2_2 : <<include>>
UC2 ..> UC2_3 : <<include>>
UC2 ..> UC2_4 : <<include>>

UC4 ..> UC5 : <<include>>

UC5 ..> UC5_1 : <<include>>
UC5 ..> UC5_2 : <<include>>
UC5 ..> UC5_3 : <<include>>
UC5 ..> UC5_4 : <<extend>>\n[si permission requise]

UC6 ..> UC6_1 : <<extend>>
UC6 ..> UC6_2 : <<extend>>
UC6 ..> UC6_3 : <<extend>>\n[si avatar fourni]

UC7 ..> UC7_1 : <<include>>
UC7 ..> UC7_2 : <<include>>
UC7 ..> UC7_3 : <<include>>
UC7 ..> UC7_4 : <<extend>>\n[pour sécurité]

UC8 ..> UC7_4 : <<include>>

UC10 ..> UC10_1 : <<extend>>
UC10 ..> UC10_2 : <<extend>>
UC10 ..> UC10_3 : <<extend>>

' Notes explicatives
note right of UC1
  Validation stricte:
  - Email unique (RFC 5322)
  - Mot de passe: min 8 chars,
    1 maj, 1 min, 1 chiffre,
    1 caractère spécial
  - Rôle par défaut: CLIENT
end note

note right of UC2
  Taux de limitation:
  - 5 tentatives / 15min
  - Blocage temporaire si dépassé
  - Log des tentatives échouées
end note

note right of UC5
  Tokens JWT:
  - Access: 15 minutes
  - Refresh: 7 jours
  - Algorithme: HS256
  - Secret: variable d'env
end note

note bottom of UC10
  Matrice RBAC:
  CLIENT:
    - read:own-bookings
    - write:own-profile

  MERCHANT:
    - read:own-resources
    - write:own-resources
    - read:own-bookings

  ADMIN:
    - all:all (super-user)
end note

note left of UC11
  Nettoyage automatique:
  - Tokens expirés > 30 jours
  - Comptes inactifs > 1 an
  - Sessions abandonnées
  - Exécution: 03:00 UTC
end note

' Contraintes
note "Inscription requiert\némail non utilisé" as N1
UC1 .. N1

note "Connexion nécessite\ncompte activé" as N2
UC2 .. N2

note "Changement mot de passe\nrévoque tous les tokens\nactifs (sécurité)" as N3
UC7 .. N3

@enduml
