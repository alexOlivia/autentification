@startuml Notification Service - Cas d'Utilisation

title Notification Service - Cas d'Utilisation

left to right direction

' Acteurs
actor "Client" as Client
actor "Commer√ßant" as Merchant
actor "Administrateur" as Admin
actor "Booking Service" as BookingService
actor "Payment Service" as PaymentService
actor "T√¢che Planifi√©e" as Cron
actor "SendGrid" as SendGrid
actor "Firebase" as Firebase
actor "Twilio" as Twilio

' Package Notification Service
rectangle "Notification Service" {
    ' Cas d'utilisation principaux
    usecase "Envoyer notifications" as UC1
    usecase "G√©rer pr√©f√©rences" as UC2
    usecase "G√©rer templates" as UC3
    usecase "Consulter historique" as UC4
    usecase "G√©rer retry √©checs" as UC5
    usecase "Envoyer notifications group√©es" as UC6
    usecase "G√©rer tokens devices" as UC7

    ' Sous-cas pour envoi notifications
    usecase "Envoyer email" as UC1_1
    usecase "Envoyer push" as UC1_2
    usecase "Envoyer SMS" as UC1_3
    usecase "V√©rifier pr√©f√©rences utilisateur" as UC1_4
    usecase "Rendre template" as UC1_5
    usecase "Logger notification" as UC1_6

    ' Sous-cas pour pr√©f√©rences
    usecase "Activer/D√©sactiver email" as UC2_1
    usecase "Activer/D√©sactiver push" as UC2_2
    usecase "Activer/D√©sactiver SMS" as UC2_3
    usecase "Configurer fr√©quence digest" as UC2_4
    usecase "D√©finir horaires ne pas d√©ranger" as UC2_5
    usecase "Filtrer types notifications" as UC2_6

    ' Sous-cas pour templates
    usecase "Cr√©er template email" as UC3_1
    usecase "Modifier template" as UC3_2
    usecase "Pr√©visualiser template" as UC3_3
    usecase "D√©finir variables" as UC3_4
    usecase "G√©rer traductions" as UC3_5

    ' Sous-cas pour historique
    usecase "Consulter notifications envoy√©es" as UC4_1
    usecase "Filtrer par type" as UC4_2
    usecase "Filtrer par canal" as UC4_3
    usecase "Filtrer par p√©riode" as UC4_4
    usecase "Marquer comme lue" as UC4_5
    usecase "Supprimer anciennes" as UC4_6

    ' Sous-cas pour retry
    usecase "D√©tecter √©chec envoi" as UC5_1
    usecase "Planifier nouvelle tentative" as UC5_2
    usecase "Appliquer backoff exponentiel" as UC5_3
    usecase "Alerter admin apr√®s 3 √©checs" as UC5_4
    usecase "Basculer canal alternatif" as UC5_5

    ' Sous-cas pour group√©es
    usecase "Composer digest quotidien" as UC6_1
    usecase "Regrouper notifications" as UC6_2
    usecase "Envoyer campagne marketing" as UC6_3
    usecase "Envoyer rappels batch" as UC6_4

    ' Sous-cas pour tokens
    usecase "Enregistrer token device" as UC7_1
    usecase "Supprimer token" as UC7_2
    usecase "Nettoyer tokens invalides" as UC7_3
    usecase "G√©rer multi-devices" as UC7_4
}

' Relations acteurs -> cas d'utilisation
Client --> UC2 : configure pr√©f√©rences
Client --> UC4 : consulte historique
Client --> UC7 : lors login/logout app

Merchant --> UC3 : personnalise templates
Merchant --> UC6 : envoie campagnes

Admin --> UC3 : g√®re tous templates
Admin --> UC4 : consulte toutes notifications
Admin --> UC5 : g√®re alertes √©checs

BookingService --> UC1 : d√©clenche notification r√©servation
PaymentService --> UC1 : d√©clenche notification paiement

Cron --> UC6 : envoie digests quotidiens
Cron --> UC4_6 : nettoie anciennes (>90j)
Cron --> UC7_3 : nettoie tokens invalides

SendGrid --> UC1_1 : envoie emails
Firebase --> UC1_2 : envoie push
Twilio --> UC1_3 : envoie SMS

' Inclusions et extensions
UC1 ..> UC1_1 : <<extend>>\n[si email activ√©]
UC1 ..> UC1_2 : <<extend>>\n[si push activ√©]
UC1 ..> UC1_3 : <<extend>>\n[si SMS activ√©]
UC1 ..> UC1_4 : <<include>>
UC1 ..> UC1_5 : <<include>>
UC1 ..> UC1_6 : <<include>>

UC1_1 ..> UC5 : <<extend>>\n[si √©chec]
UC1_2 ..> UC5 : <<extend>>\n[si √©chec]
UC1_3 ..> UC5 : <<extend>>\n[si √©chec]

UC2 ..> UC2_1 : <<extend>>
UC2 ..> UC2_2 : <<extend>>
UC2 ..> UC2_3 : <<extend>>
UC2 ..> UC2_4 : <<extend>>
UC2 ..> UC2_5 : <<extend>>
UC2 ..> UC2_6 : <<extend>>

UC3 ..> UC3_1 : <<extend>>
UC3 ..> UC3_2 : <<extend>>
UC3 ..> UC3_3 : <<extend>>
UC3 ..> UC3_4 : <<include>>
UC3 ..> UC3_5 : <<extend>>

UC4 ..> UC4_1 : <<include>>
UC4 ..> UC4_2 : <<extend>>
UC4 ..> UC4_3 : <<extend>>
UC4 ..> UC4_4 : <<extend>>
UC4 ..> UC4_5 : <<extend>>
UC4 ..> UC4_6 : <<extend>>

UC5 ..> UC5_1 : <<include>>
UC5 ..> UC5_2 : <<include>>
UC5 ..> UC5_3 : <<include>>
UC5 ..> UC5_4 : <<extend>>\n[si max retry]
UC5 ..> UC5_5 : <<extend>>\n[si possible]

UC6 ..> UC6_1 : <<extend>>
UC6 ..> UC6_2 : <<include>>
UC6 ..> UC6_3 : <<extend>>
UC6 ..> UC6_4 : <<extend>>

UC7 ..> UC7_1 : <<extend>>
UC7 ..> UC7_2 : <<extend>>
UC7 ..> UC7_3 : <<extend>>
UC7 ..> UC7_4 : <<include>>

' Notes explicatives
note right of UC1
  Types de notifications:

  RESERVATION_CONFIRMEE:
  - Canaux: Email + Push
  - Priorit√©: Haute
  - Template: confirmation
  - Attachement: QR code

  RESERVATION_RAPPEL (J-1):
  - Canaux: Email + Push + SMS
  - Priorit√©: Haute
  - Timing: 10h00 veille
  - Contenu: D√©tails + annulation

  RESERVATION_ANNULEE:
  - Canaux: Email + Push
  - Priorit√©: Haute
  - Contenu: Raison + remboursement

  PAIEMENT_REUSSI:
  - Canaux: Email + Push
  - Priorit√©: Haute
  - Attachement: Facture PDF

  PAIEMENT_ECHOUE:
  - Canaux: Email + Push + SMS
  - Priorit√©: Critique
  - Contenu: Raison + nouvelle tentative

  REMBOURSEMENT_TRAITE:
  - Canaux: Email + Push
  - Priorit√©: Moyenne
  - Contenu: Montant + d√©lai

  PROMOTION:
  - Canaux: Email (opt-in)
  - Priorit√©: Basse
  - Fr√©quence: Max 1/semaine
end note

note right of UC2
  Pr√©f√©rences granulaires:

  Par canal:
  - Email: ON/OFF
  - Push: ON/OFF
  - SMS: ON/OFF

  Par type:
  - Confirmations: ON (forc√©)
  - Rappels: ON/OFF
  - Annulations: ON (forc√©)
  - Paiements: ON (forc√©)
  - Promotions: ON/OFF
  - Messages commer√ßant: ON/OFF

  Fr√©quence:
  - TEMPS_REEL: imm√©diat
  - QUOTIDIEN: digest 8h
  - HEBDOMADAIRE: digest lundi
  - JAMAIS: d√©sactiv√©

  Horaires:
  - Ne pas d√©ranger: 22h-8h
  - Weekend: ON/OFF
  - Exceptions: confirmations toujours

  Interface:
  - Page param√®tres app mobile
  - Switches ON/OFF
  - Sauvegarde instantan√©e
end note

note bottom of UC3
  Templates dynamiques:

  Template CONFIRMATION_RESERVATION:
  ```
  Sujet: R√©servation confirm√©e - {{restaurant.nom}}

  Bonjour {{client.prenom}},

  Votre r√©servation est confirm√©e! \u2705

  üìç Restaurant: {{restaurant.nom}}
  üìÖ Date: {{reservation.date | format "DD/MM/YYYY"}}
  üïê Heure: {{reservation.heure}}
  üë• Personnes: {{reservation.nombrePersonnes}}
  ü™ë Table: {{table.numero}}
  üí∞ Prix: {{reservation.prix}} XOF

  Code confirmation: {{reservation.code}}

  [Bouton: Voir ma r√©servation]
  [Bouton: Annuler (remboursement 100%)]

  Adresse: {{restaurant.adresse}}
  T√©l√©phone: {{restaurant.telephone}}

  Bon app√©tit!
  L'√©quipe PING
  ```

  Variables disponibles:
  - client.*
  - reservation.*
  - restaurant.*
  - table.*
  - paiement.*

  Helpers:
  - format (date, devise, t√©l√©phone)
  - uppercase, lowercase
  - truncate, pluralize
  - traduction (i18n)
end note

note right of UC4
  Historique notifications:

  Affichage:
  - Liste chronologique
  - Badge non lues
  - Ic√¥ne par type
  - Horodatage relatif
    ("il y a 2h", "hier", "3 jours")

  Filtres:
  - Lues/Non lues
  - Par type (r√©servation, paiement)
  - Par canal (email, push, SMS)
  - Derni√®res 24h/7j/30j

  Actions:
  - Marquer lue
  - Marquer toutes lues
  - Supprimer
  - Renvoyer (si √©chec)

  R√©tention:
  - Stockage: 90 jours
  - Archivage: S3/stockage froid
  - Suppression auto apr√®s 90j
  - Conformit√© RGPD
end note

note left of UC5
  Gestion √©checs robuste:

  D√©tection:
  - Code erreur fournisseur
  - Timeout (>30s)
  - Exception r√©seau

  Classification:
  - Temporaire (500, timeout)
    ‚Üí Retry automatique
  - Permanent (400, invalid email)
    ‚Üí Pas de retry, logger

  Retry strategy:
  1. Attendre 30s
  2. Attendre 2min (√ó4)
  3. Attendre 10min (√ó16)
  4. √âchec final ‚Üí Alert admin

  Canal alternatif:
  - Si Email √©choue 3√ó
    ‚Üí Essayer Push
  - Si Push √©choue
    ‚Üí Essayer SMS (si critique)

  Queue Redis:
  - Notifications en attente retry
  - Worker traite queue async
  - Priorit√© par type notification
end note

note right of UC6
  Notifications group√©es:

  Digest quotidien (8h00):
  - Regroupe notifications 24h
  - Par cat√©gorie
  - 1 seul email
  - R√©sum√© + liens d√©tails

  Exemple:
  "Bonjour Amadou,

  R√©sum√© de vos notifications:

   R√©servations (2):
  - Table T5 confirm√©e 18 mars 19h
  - Chambre 203 confirm√©e 20-22 mars

  üí∞ Paiements (1):
  - 75000 XOF pay√© r√©servation h√¥tel

  üìä Activit√©:
  - 2 nouvelles r√©servations
  - Taux occupation: 65%

  [Voir toutes les notifications]"

  Campagnes marketing:
  - Opt-in obligatoire
  - Segmentation utilisateurs
  - A/B testing
  - D√©sinscription facile

  Rappels batch:
  - Tous rappels J-1 √† 10h
  - Group√©s par service
  - Parall√©lisation envois
end note

note right of UC7
  Gestion tokens devices:

  Cycle de vie:
  1. App mobile install√©e
  2. Firebase g√©n√®re token FCM
  3. App envoie token au backend
  4. Backend enregistre token + userId
  5. Notifications envoy√©es √† ce token
  6. App d√©sinstall√©e ou logout
  7. Token supprim√©

  Multi-devices:
  - Utilisateur peut avoir plusieurs devices
  - iPhone, Android, iPad, etc.
  - Notifications envoy√©es √† tous
  - Max 5 devices/utilisateur

  Nettoyage:
  - Tokens invalides (erreur FCM)
  - Tokens inactifs >90 jours
  - T√¢che quotidienne 3h00
  - √âconomie co√ªts FCM

  S√©curit√©:
  - Token li√© √† userId
  - Validation propri√©taire
  - R√©vocation possible
end note

' Contraintes
note "Email requis pour\nnotifications critiques\n(confirmation, paiement)" as N1
UC1_1 .. N1

note "Pr√©f√©rences respect√©es sauf\nnotifications l√©gales obligatoires" as N2
UC2 .. N2

note "Templates doivent contenir\nvariables obligatoires selon type" as N3
UC3 .. N3

note "Historique conserv√© 90 jours\npuis archiv√© (RGPD)" as N4
UC4 .. N4

note "Max 3 tentatives retry\navant escalade admin" as N5
UC5 .. N5

note "Fr√©quence max promotions:\n1 email/semaine par utilisateur" as N6
UC6 .. N6

@enduml
