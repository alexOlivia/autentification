@startuml Notification Service - Mod√®le de Domaine

title Notification Service - Mod√®le de Domaine Conceptuel

' Styles
skinparam class {
    BackgroundColor Lavender
    BorderColor Purple
    ArrowColor Purple
}

package "Domaine Notification" {

    ' ========== ENTIT√âS ==========

    class Notification <<entit√©>> {
        + id: string
        + destinataireId: string
        + typeNotification: TypeNotification
        + canal: CanalNotification
        + priorite: PrioriteNotification
        + titre: string
        + message: string
        + donneesJSON: string
        + statut: StatutNotification
        + dateCreation: Date
        + dateEnvoi: Date
        + dateLecture: Date
        + nombreTentatives: number
        + erreurDernier: string
    }

    class TemplateNotification <<entit√©>> {
        + id: string
        + code: string
        + typeNotification: TypeNotification
        + canal: CanalNotification
        + langue: string
        + sujet: string
        + corpsTexte: string
        + corpsHTML: string
        + variables: string[]
        + estActif: boolean
        + dateCreation: Date
    }

    class PreferenceNotification <<entit√©>> {
        + id: string
        + utilisateurId: string
        + typeNotification: TypeNotification
        + canalEmail: boolean
        + canalPush: boolean
        + canalSMS: boolean
        + estActive: boolean
        + dateModification: Date
    }

    class TokenPush <<entit√©>> {
        + id: string
        + utilisateurId: string
        + token: string
        + plateforme: PlateformeMobile
        + modeleAppareil: string
        + versionApp: string
        + estActif: boolean
        + dateCreation: Date
        + dateDerniereUtilisation: Date
    }

    class HistoriqueEnvoi <<entit√©>> {
        + id: string
        + notificationId: string
        + canal: CanalNotification
        + adresseDestination: string
        + statut: StatutEnvoi
        + codeReponseProvider: string
        + messageErreur: string
        + tempsTraitementMs: number
        + dateEnvoi: Date
    }

    ' ========== √âNUM√âRATIONS ==========

    enum TypeNotification {
        RESERVATION_CONFIRMEE
        RESERVATION_ANNULEE
        PAIEMENT_REUSSI
        PAIEMENT_ECHOUE
        RAPPEL_RESERVATION
        DEMANDE_AVIS
        NOUVEAU_MESSAGE
        PROMOTION
        ALERTE_PRIX
        MISE_A_JOUR_STATUT
        AUTRE
    }

    enum CanalNotification {
        EMAIL
        PUSH
        SMS
        IN_APP
    }

    enum PrioriteNotification {
        BASSE
        NORMALE
        HAUTE
        URGENTE
    }

    enum StatutNotification {
        EN_ATTENTE
        EN_COURS_ENVOI
        ENVOYEE
        LIVREE
        ECHOUEE
        LUE
    }

    enum StatutEnvoi {
        SUCCES
        ECHEC_TEMPORAIRE
        ECHEC_PERMANENT
    }

    enum PlateformeMobile {
        ANDROID
        IOS
        WEB
    }
}

' ========== RELATIONS ==========

Notification "1" -- "1" TypeNotification : est de type >
Notification "1" -- "1" CanalNotification : utilise >
Notification "1" -- "1" PrioriteNotification : a une priorit√© >
Notification "1" -- "1" StatutNotification : a un statut >
Notification "1" -- "*" HistoriqueEnvoi : g√©n√®re >

TemplateNotification "1" -- "1" TypeNotification : pour >
TemplateNotification "1" -- "1" CanalNotification : sur >

PreferenceNotification "*" --> "1" TypeNotification : pour >

TokenPush "1" -- "1" PlateformeMobile : sur >

HistoriqueEnvoi "1" -- "1" CanalNotification : par >
HistoriqueEnvoi "1" -- "1" StatutEnvoi : a un statut >
HistoriqueEnvoi "*" --> "1" Notification : de >

' ========== NOTES M√âTIER ==========

note right of Notification
  **Notification utilisateur**

  **Types notification:**

  - **RESERVATION_CONFIRMEE:**
    Confirmation r√©servation apr√®s paiement
    (Priorit√©: HAUTE)

  - **RESERVATION_ANNULEE:**
    Annulation r√©servation (client/commer√ßant)
    (Priorit√©: HAUTE)

  - **PAIEMENT_REUSSI:**
    Confirmation paiement effectu√©
    (Priorit√©: HAUTE)

  - **PAIEMENT_ECHOUE:**
    √âchec paiement, action requise
    (Priorit√©: URGENTE)

  - **RAPPEL_RESERVATION:**
    Rappel J-7, J-1, H-2
    (Priorit√©: NORMALE)

  - **DEMANDE_AVIS:**
    Demande √©valuation apr√®s s√©jour
    (Priorit√©: BASSE)

  - **NOUVEAU_MESSAGE:**
    Message commer√ßant ‚Üî client
    (Priorit√©: NORMALE)

  - **PROMOTION:**
    Offre sp√©ciale, r√©duction
    (Priorit√©: BASSE)

  - **ALERTE_PRIX:**
    Baisse prix ressource suivie
    (Priorit√©: NORMALE)

  - **MISE_A_JOUR_STATUT:**
    Changement statut r√©servation
    (Priorit√©: NORMALE)

  **Canaux:**
  - EMAIL: pour d√©tails complets
  - PUSH: pour alertes temps r√©el
  - SMS: pour confirmations importantes
  - IN_APP: pour consultations ult√©rieures

  **Donn√©es JSON:**
  M√©tadonn√©es pour deep linking
  Ex: {"reservationId": "abc123", "action": "view"}
  ‚Üí Clic notification ouvre app sur r√©servation
end note

note bottom of TemplateNotification
  **Mod√®le de notification**

  Templates r√©utilisables avec variables
  dynamiques (personnalisation).

  **Exemple template:**

  **Code:** RESERVATION_CONFIRMEE_EMAIL_FR

  **Sujet:**
  "R√©servation confirm√©e - {{nomEtablissement}}"

  **Corps HTML:**
  ```
  Bonjour {{prenomClient}},

  Votre r√©servation est confirm√©e !

  üìÖ Date: {{dateReservation}}
  üè® √âtablissement: {{nomEtablissement}}
  üìç Adresse: {{adresseEtablissement}}
  üí∞ Montant pay√©: {{montantPaye}} {{devise}}
  üîë Code confirmation: {{codeConfirmation}}

  Pr√©sentez ce code √† votre arriv√©e.

  [Voir les d√©tails] [Annuler]

  Cordialement,
  L'√©quipe PING
  ```

  **Variables:**
  - prenomClient
  - dateReservation
  - nomEtablissement
  - adresseEtablissement
  - montantPaye
  - devise
  - codeConfirmation

  **Multi-langue:**
  Templates dans plusieurs langues:
  - Fran√ßais (FR)
  - Anglais (EN)
  - Wolof (WO) - contexte S√©n√©gal
  - Bambara (BM) - contexte Mali

  **Versions canal:**
  M√™me notification, templates diff√©rents:
  - EMAIL: HTML riche avec images
  - SMS: texte court (160 caract√®res max)
  - PUSH: titre + message court
  - IN_APP: texte d√©taill√© avec actions

  **Gestion:**
  Modifiables par admin sans red√©ploiement
  A/B testing possible (variantes)
end note

note right of PreferenceNotification
  **Pr√©f√©rences utilisateur**

  Contr√¥le granulaire notifications re√ßues.

  **Exemples pr√©f√©rences:**

  **Client conservateur:**
  - RESERVATION_CONFIRMEE: Email ‚úì Push ‚úì SMS ‚úì
  - PAIEMENT_REUSSI: Email ‚úì Push ‚úì SMS ‚úó
  - RAPPEL_RESERVATION: Email ‚úì Push ‚úì SMS ‚úó
  - DEMANDE_AVIS: Email ‚úì Push ‚úó SMS ‚úó
  - PROMOTION: Email ‚úó Push ‚úó SMS ‚úó

  **Client minimaliste:**
  - RESERVATION_CONFIRMEE: Email ‚úó Push ‚úì SMS ‚úó
  - PAIEMENT_REUSSI: Email ‚úó Push ‚úì SMS ‚úó
  - Tout le reste: d√©sactiv√©

  **R√®gles par d√©faut:**
  Nouvellement inscrits:
  - Notifications critiques: tous canaux ‚úì
  - Notifications marketing: d√©sactiv√©es ‚úó

  **RGPD:**
  Opt-in explicite pour promotions
  Opt-out facile (lien email)

  **Contexte africain:**
  - SMS co√ªteux ‚Üí usage mod√©r√©
  - Push privil√©gi√© (connexion internet)
  - Email secondaire (faible consultation)

  **Respect pr√©f√©rences:**
  Syst√®me v√©rifie pr√©f√©rences avant envoi
  Si tous canaux d√©sactiv√©s: notification non envoy√©e
  Exception: notifications l√©gales obligatoires
end note

note bottom of TokenPush
  **Token notification push**

  Jeton FCM (Firebase Cloud Messaging)
  pour envoi notifications push.

  **Fonctionnement:**
  1. App mobile g√©n√®re token FCM
  2. Token envoy√© √† backend (registration)
  3. Stockage token + m√©tadonn√©es
  4. Envoi notification via token

  **M√©tadonn√©es:**
  - Plateforme: Android ou iOS
  - Mod√®le appareil: Samsung Galaxy S21, iPhone 13
  - Version app: 1.2.3

  **Multi-appareils:**
  Utilisateur peut avoir plusieurs tokens
  (t√©l√©phone + tablette + web)
  ‚Üí Notification envoy√©e sur tous appareils actifs

  **Gestion tokens:**
  - estActif = false si:
    * App d√©sinstall√©e
    * Token expir√©
    * Utilisateur d√©connect√©

  - Nettoyage automatique:
    Tokens inactifs >90 jours supprim√©s

  **S√©curit√©:**
  - Token r√©g√©n√©r√© p√©riodiquement (FCM)
  - Mise √† jour automatique c√¥t√© app
  - Chiffrement token au repos

end note

note right of HistoriqueEnvoi
  **Historique envois**

  Trace d√©taill√©e chaque tentative envoi
  pour monitoring et debug.

  **Informations collect√©es:**

  - Canal utilis√© (Email, Push, SMS)
  - Adresse destination:
    * Email: email@example.com
    * Push: token FCM
    * SMS: +221771234567

  - Statut:
    * SUCCES: livr√©
    * ECHEC_TEMPORAIRE: retry possible
    * ECHEC_PERMANENT: abandon

  - Code r√©ponse provider:
    * SendGrid: 202 (accepted)
    * Firebase: 200 (success)
    * Twilio: 201 (created)

  - Message erreur si √©chec:
    * "Invalid email address"
    * "Token not registered" (push)
    * "Insufficient funds" (SMS)

  - Temps traitement:
    Dur√©e envoi en millisecondes
    (pour monitoring performance)

  **Retry automatique:**
  Si ECHEC_TEMPORAIRE (timeout, rate limit):
  - Tentative 1: imm√©diate
  - Tentative 2: +1 min
  - Tentative 3: +5 min
  - Tentative 4: +15 min
  - Abandon apr√®s 4 √©checs

  **Utilit√©:**
  - D√©tecter probl√®mes providers
  - Statistiques d√©livrabilit√©
  - R√©solution incidents clients
  - Analyse performance

  **Conservation:**
  - 90 jours (RGPD)
  - Anonymisation apr√®s 90j
end note

note as N1
  **Flux notification**

  **1. √âv√©nement d√©clencheur:**
  Service m√©tier publie √©v√©nement Redis:
  - booking.confirmed
  - payment.success
  - booking.reminder

  **2. R√©ception √©v√©nement:**
  Notification Service √©coute (subscribe)
  Identifie type notification √† envoyer

  **3. V√©rification pr√©f√©rences:**
  Lecture pr√©f√©rences utilisateur
  Filtrage canaux autoris√©s

  **4. G√©n√©ration contenu:**
  S√©lection template appropri√©
  (type + langue utilisateur)
  Remplacement variables dynamiques

  **5. Cr√©ation notification:**
  Enregistrement BD (statut: EN_ATTENTE)
  Pour chaque canal autoris√©

  **6. Envoi multi-canal:**
  - Email: SendGrid API
  - Push: Firebase FCM API
  - SMS: Twilio API (optionnel)
  - In-app: WebSocket (temps r√©el)

  **7. Traitement r√©ponses:**
  - Mise √† jour statuts (ENVOYEE/ECHOUEE)
  - Enregistrement historique
  - Retry si √©chec temporaire

  **8. Tracking:**
  - Email: tracking ouverture (pixel)
  - Push: Firebase analytics (livraison)
  - SMS: delivery status (webhook Twilio)
  - In-app: marquage LUE au clic

  **Priorit√©s:**
  URGENTE: envoi imm√©diat
  HAUTE: <1 min
  NORMALE: <5 min
  BASSE: batch horaire (optimisation co√ªts)
end note

@enduml
